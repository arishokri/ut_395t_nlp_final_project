# Sweep configuration combining filtering with smoothing/weighting
# Experiments that combine data filtering strategies with training modifications
# (cluster filtering does not filter validation set to avoid cluster mismatch)

program: run.py
method: bayes # Bayesian optimization for efficiency
project: qa-cartography-experiments
name: combined-strategies

# Metric to optimize
# Using F1 instead of exact_match because:
# - F1 is more lenient and rewards partial matches, providing better training signal
# - Exact match is very strict (single char difference = wrong), can be noisy for model selection
# - F1 correlates well with EM; both metrics are logged to W&B for comparison
metric:
  name: eval/f1
  goal: maximize

# Fixed parameters for all runs
parameters:
  # Model and dataset
  model:
    value: google/electra-small-discriminator
  dataset:
    value: Eladio/emrqa-msquad
  max_length:
    value: 512

  # Dataset size limits (set to null for full dataset)
  max_train_samples:
    value: 5000 # null = use full training set
  max_eval_samples:
    value: 2000 # null = use full validation set

  # Training configuration
  num_train_epochs:
    value: 3
  per_device_train_batch_size:
    value: 64

  # Enable cartography tracking
  enable_cartography:
    value: false

  # Apply filtering to validation set (only applies when filter_ambiguous=true)
  # Note: Validation is NOT filtered in cluster filtering mode to avoid cluster mismatch
  filter_validation:
    value: true

  # Combined strategies search space

  # Filtering strategies (from filtering_strategies_sweep.yaml)
  filter_rule_based:
    values: [true, false]

  filter_ambiguous:
    values: [true, false]

  ambiguous_top_fraction:
    distribution: uniform
    min: 0.25
    max: 0.70

  train_variability_margin:
    distribution: uniform
    min: -0.25
    max: 0.25

  filter_clusters:
    values: [true, false]

  exclude_noise_cluster:
    values: [true, false]

  min_cluster_probability:
    distribution: uniform
    min: 0.5
    max: 0.9

  # Smoothing/weighting strategies (from smoothing_weighting_sweep.yaml)
  use_label_smoothing:
    values: [true, false]

  smoothing_factor:
    distribution: uniform
    min: 0.2
    max: 0.8

  use_soft_weighting:
    values: [true, false]

  weight_clip_min:
    distribution: uniform
    min: 0.05
    max: 0.2

  weight_clip_max:
    distribution: uniform
    min: 5
    max: 15

  # Drop percentage threshold - terminate early if too much data is dropped
  max_drop_percentage:
    value: 30 # Fail if more than 30% of data is dropped (filtered out)

# Early termination for poorly performing runs
early_terminate:
  type: hyperband
  min_iter: 1
  eta: 3
  # s: 2
